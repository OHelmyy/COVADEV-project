{% extends "base.html" %}
{% block content %}

<!-- =========================
     PROJECT HEADER
========================= -->
<div class="card">
  <h2>{{ project.name }}</h2>
  <div class="muted">{{ project.description|default:"No description" }}</div>
  <div class="muted" style="margin-top:8px;">
    Your role: <b>{{ membership.role }}</b>
  </div>
</div>

<!-- =========================
     ACTIVE UPLOADS + QUICK STATS
========================= -->
<div class="card">
  <h3>Current Uploads</h3>

  <div class="row" style="grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;">
    <div class="card">
      <div class="muted">Active BPMN</div>
      <div style="font-weight:800; margin-top:4px;">
        {% if project.active_bpmn %}
          {{ project.active_bpmn.original_name }}
        {% else %}
          <span class="muted">None uploaded yet</span>
        {% endif %}
      </div>
      {% if project.active_bpmn and project.active_bpmn.uploaded_by %}
        <div class="muted small" style="margin-top:6px;">
          Uploaded by {{ project.active_bpmn.uploaded_by.username }} • {{ project.active_bpmn.created_at }}
        </div>
      {% endif %}
    </div>

    <div class="card">
      <div class="muted">Active Code ZIP</div>
      <div style="font-weight:800; margin-top:4px;">
        {% if project.active_code %}
          {{ project.active_code.original_name }}
        {% else %}
          <span class="muted">None uploaded yet</span>
        {% endif %}
      </div>
      {% if project.active_code and project.active_code.uploaded_by %}
        <div class="muted small" style="margin-top:6px;">
          Uploaded by {{ project.active_code.uploaded_by.username }} • {{ project.active_code.created_at }}
        </div>
      {% endif %}
    </div>
  </div>

  <div class="row" style="grid-template-columns: 1fr 1fr 1fr; margin-top:12px;">
    <div class="card">
      <div class="muted">Indexed files</div>
      <div style="font-size:22px; font-weight:800;">{{ code_files_count }}</div>
    </div>
    <div class="card">
      <div class="muted">BPMN tasks</div>
      <div style="font-size:22px; font-weight:800;">{{ tasks_count }}</div>
    </div>
    <div class="card">
      <div class="muted">Match results</div>
      <div style="font-size:22px; font-weight:800;">{{ matches_count }}</div>
    </div>
  </div>
</div>
{% if project.active_bpmn %}
  <div class="section card">
    <h3>Pre-development</h3>

    <div class="row" style="grid-template-columns: 1fr 1fr; gap:16px; margin-top:12px;">
      <div class="card">
        <div class="muted">BPMN Well-Formed Check</div>

        {% if project.active_bpmn.is_well_formed %}
          <div style="margin-top:8px; font-weight:900;">✅ Valid BPMN/XML</div>
        {% else %}
          <div style="margin-top:8px; font-weight:900;">❌ Invalid BPMN/XML</div>
        {% endif %}

        {% if project.active_bpmn.precheck_warnings and project.active_bpmn.precheck_warnings|length > 0 %}
          <div class="small muted" style="margin-top:10px;">Warnings</div>
          <pre class="codebox" style="margin-top:8px; max-height:160px; overflow:auto;">{% for w in project.active_bpmn.precheck_warnings %}- {{ w }}
{% endfor %}</pre>
        {% endif %}

        {% if project.active_bpmn.precheck_errors and project.active_bpmn.precheck_errors|length > 0 %}
          <div class="small muted" style="margin-top:10px;">Errors</div>
          <pre class="codebox" style="margin-top:8px; max-height:160px; overflow:auto;">{% for e in project.active_bpmn.precheck_errors %}- {{ e }}
{% endfor %}</pre>
        {% endif %}
      </div>

      <div class="card">
        <div class="muted">BPMN Summary (T5)</div>

        {% if project.active_bpmn.bpmn_summary %}
          <div style="margin-top:10px; font-weight:700; line-height:1.6;">
            {{ project.active_bpmn.bpmn_summary }}
          </div>
        {% else %}
          <div class="muted" style="margin-top:10px;">No summary generated yet.</div>
        {% endif %}

        <div class="small muted" style="margin-top:10px;">
          Generated from extracted process/tasks (no manual descriptions required).
        </div>
      </div>
    </div>
  </div>
{% endif %}
<!-- =========================
     UPLOAD + ANALYSIS TOOLS
========================= -->
<div class="card">
  <h3>Tools</h3>

  <div class="row" style="margin-top:12px;">
    <!-- BPMN Upload: Evaluator only -->
    <div class="card">
      <h4>Upload BPMN</h4>

      
        <form method="post" enctype="multipart/form-data" action="{% url 'projects:upload_bpmn' project.id %}">
          {% csrf_token %}
          <input class="input" type="file" name="bpmn_file" accept=".bpmn,.xml" required />
          <button class="btn" type="submit" style="margin-top:10px;">Upload BPMN</button>
        </form>
        
      
      
    </div>

    <!-- Code ZIP Upload: Any member -->
    <div class="card">
      <h4>Upload Code ZIP</h4>
      <form method="post" enctype="multipart/form-data" action="{% url 'projects:upload_code' project.id %}">
        {% csrf_token %}
        <input class="input" type="file" name="code_zip" accept=".zip" required />
        <button class="btn" type="submit" style="margin-top:10px;">Upload &amp; Index</button>
      </form>
      <div class="muted small" style="margin-top:8px;">
        Allowed for evaluator and developers.
      </div>
    </div>
  </div>

  <!-- Run analysis: Any member -->
  <div class="card" style="margin-top:12px;">
    <h4>Run Analysis</h4>
    <form method="post" action="{% url 'projects:run_analysis' project.id %}">
      {% csrf_token %}
      <button class="btn" type="submit">Run analysis</button>
    </form>
    <div class="muted small" style="margin-top:8px;">
      Runs analysis using the current active BPMN + active code.
    </div>
  </div>
</div>

<!-- =========================
     PROJECT SETTINGS (Evaluator)
========================= -->
<div class="card">
  <h3>Settings</h3>

  <div class="muted">
    Similarity threshold: <b>{{ project.similarity_threshold }}</b>
  </div>

  {% if membership.role == "EVALUATOR" %}
    <form method="post" action="{% url 'projects:update_threshold' project.id %}" style="margin-top:10px;">
      {% csrf_token %}
      <input class="input" type="text" name="similarity_threshold" placeholder="e.g., 0.6" />
      <button class="btn" type="submit" style="margin-top:10px;">Update threshold</button>
    </form>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
      <a class="btn" href="{% url 'projects:members' project.id %}">Manage Members</a>
      <a class="btn" href="{% url 'projects:upload_logs' project.id %}">Upload Logs</a>
    </div>
  {% else %}
    <div class="muted" style="margin-top:10px;">
      Only evaluator can change settings and view upload logs.
    </div>
  {% endif %}
</div>

<!-- =========================
     RUNS HISTORY
========================= -->
<div class="card">
  <h3>Analysis Runs (latest 10)</h3>
  {% for r in runs %}
    <div style="border-top:1px solid #1f2937; padding-top:10px; margin-top:10px;">
      <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
        <div>
          <div style="font-weight:800;">Run #{{ r.id }} — {{ r.status }}</div>
          <div class="muted small">
            Started: {{ r.started_at }} | Finished: {{ r.finished_at }}
          </div>
        </div>
      </div>

      {% if r.error_message %}
        <div class="muted" style="margin-top:6px;">Error: {{ r.error_message }}</div>
      {% endif %}
    </div>
  {% empty %}
    <div class="muted">No runs yet.</div>
  {% endfor %}
</div>
<!-- =========================
     ANALYSIS OUTPUT (Live)
========================= -->
<div class="card">
  <h3>Live Analysis Output</h3>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
    <button class="btn" type="button" id="runAnalysisBtn">
      Run & Show Results
    </button>

    <div class="muted small" style="align-self:center;">
      Uses active BPMN + active code and shows summary/details + extracted texts.
    </div>
  </div>

  <div class="row" style="grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;">
    <div class="card">
      <div class="muted">Summary</div>
      <pre id="analysisSummary" style="margin-top:8px;">Waiting...</pre>
    </div>

    <div class="card">
      <div class="muted">Details</div>
      <pre id="analysisDetails" style="margin-top:8px;">Waiting...</pre>
    </div>
  </div>

  <div class="row" style="grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;">
    <div class="card">
      <div class="muted">BPMN tasks (extracted text preview)</div>
      <pre id="analysisTasks" style="margin-top:8px;">Waiting...</pre>
    </div>

    <div class="card">
      <div class="muted">Code items (extracted text preview)</div>
      <pre id="analysisCode" style="margin-top:8px;">Waiting...</pre>
    </div>
  </div>
</div>
<!-- =========================
     MEMBERS LIST
========================= -->
<div class="card">
  <h3>Members</h3>

  {% for m in members %}
    <div style="display:flex; justify-content:space-between; border-top:1px solid #1f2937; padding-top:10px; margin-top:10px;">
      <div>
        <div style="font-weight:800;">{{ m.user.username }}</div>
        <div class="muted">{{ m.role }}</div>
      </div>
    </div>
  {% empty %}
    <div class="muted">No members.</div>
  {% endfor %}
</div>


<script>
(function () {
  const projectId = "{{ project.id }}";

  const btn = document.getElementById("runAnalysisBtn");
  const summaryEl = document.getElementById("analysisSummary");
  const detailsEl = document.getElementById("analysisDetails");
  const tasksEl = document.getElementById("analysisTasks");
  const codeEl = document.getElementById("analysisCode");

  function setAll(text) {
    summaryEl.textContent = text;
    detailsEl.textContent = text;
    tasksEl.textContent = text;
    codeEl.textContent = text;
  }

  async function runAndShow() {
    setAll("Loading...");

    try {
      // Use the project threshold already displayed on the page
      const threshold = "{{ project.similarity_threshold|default:'0.7' }}";
      const url = `/api/analysis/${projectId}/run/?threshold=${encodeURIComponent(threshold)}&top_k=3`;

      const res = await fetch(url);
      const bodyText = await res.text();
      if (!res.ok) throw new Error(`Run failed (${res.status}):\n${bodyText}`);

      const data = JSON.parse(bodyText);

      summaryEl.textContent = JSON.stringify(data.summary || {}, null, 2);
      detailsEl.textContent = JSON.stringify(data.details || {}, null, 2);

      const previews = data.previews || {};
      tasksEl.textContent = JSON.stringify(previews.bpmn_tasks || [], null, 2);
      codeEl.textContent = JSON.stringify(previews.code_items || [], null, 2);

    } catch (err) {
      setAll("ERROR:\n" + err.message);
      console.error(err);
    }
  }

  if (btn) btn.addEventListener("click", runAndShow);
})();
</script>

{% endblock %}
